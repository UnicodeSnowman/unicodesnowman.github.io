<!doctype html>
<html>
  <head>
    <title>Aquarium Drunkard Radio</title>
    <script src="./Dropbox-sdk.min.js"></script>
    <style>
      body {
        background-color: #f9f8f4;
      }

      .container {
        background-color: #f9f8f4;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100vh;
      }

      .hidden {
        visibility: hidden;
      }

      #audio-player {
        display: none;
      }

      #ad-logo {
        fill: #d94636;
        cursor: pointer;
      }

      .pulse {
        animation: pulse 2s infinite;
      }

      @keyframes pulse {
        0% {
          transform: scale(0.95);
        }

        50% {
          transform: scale(1);
        }

        100% {
          transform: scale(0.95);
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <svg id="ad-logo" xmlns="http://www.w3.org/2000/svg" width="223.12" height="105.9" viewBox="0 0 260 105.9">
        <title>Aquarium Drunkard</title>
        <path d="M75.33,1.67c-11.22,15-8.46,31.15-11.61,46.79,1.91,3.76,4.39.29,6.38,3.16-7.22,2-14.49,4.53-21.49,3.61,10-4.52,9.93-14.26,11.08-23C42.46,24.62,42.43,52.7,24.19,62.6,11.13,69.68-11.88,56.54,7.4,40.08c3.5.42,7,.36,10.33,3.46C16.18,45.63,18.5,48,15.9,50c-3.66,1.6-6.84-2.87-10.43-2.14-3.72,1.92-2,4.26-3.15,6.38C17.46,74.07,38.5,48.8,43,34.25c-6.36-2.62-15.23-5.58-12.85-13.59,2.38-2.09,4.5-1,6.69-.8,2.61,3.07-1.3,5.64,1.3,8.72a6.61,6.61,0,0,0,6.49,1.83c5.27-8.34,11.09-18.95,2.06-26.34,9.6-1.36,19.52-6.76,28.67-2.4m-16,1.4c-6.3,9-8.19,18.36-10.78,27.65,4.33-1.76,8.35.48,12.86-3.63-.82-7.36,8.76-22.23-2.08-24M105.48,22c-5.12,8,4.73,15.8-2.34,23.8-10.39-4,1.38-13.59-4.22-19.76-2.24-1.78-6.4,1.11-6.56,4-.7,4.16,5.59.71,4.67,3.25-2.08,5.31-6.86,10.64.2,15.85,4.83-1.38,9.67-2.08,14.47-5.44-5.15-7.21-1.06-14.52-6.22-21.73m-15.75.82L91,25.28c-6.28,11.45-3,29.58-13.68,37.26-1.89-6.42,3.1-10.58,3.3-16.32-2.51-1.52-5.88-.44-7.94-3.31C70,30.3,77,19.68,89.73,22.77M76.85,42.89c8.26-1.53,9.72-10.49,6.63-18-6,4.76-7.81,10.88-6.63,18m56.43-2c-.27-8.19-13-28.22-17.12-9.58,3.45,3.22,2.86-4.89,7.72-3.21.79,4.56,3,7.85,3.81,12.41-1.47,1-1.37,3.78-4,3.47-4.83-1.42-.44-9-2-11.36-4.13,3.28-6.57,10.34-2.91,14.75,7.39.77,11.23-2.53,14.5-6.48M151,25.21c-6.18-2.77-10.33,0-14.55,2.54,3.08,6.15,2.52,13.63,2.72,20.85,3,1.83,4.68,0,6.64-1.06-2-5.67-4-14.83-1-20,2.61,1,1.43,4.46,4.69,3.19,1.81-2.3.56-3.49,1.51-5.48m8.27-10.8c-.94.89-2.09.75-2.84,2.6.77.52,1.56,1,2.35,1.55,1.39-1.63,1.74-3.06.49-4.15m.09,31.82c-2.19-6.13,4.79-17.5-4.75-19.92,1.65,7.89-.12,15.62,1.13,22,3.22,2.58,6.31,4.46,8.05-.3-.59-3.11-2.24.21-4.43-1.79m24.14-23c-7.86,3.08,4,20.19-7.91,22.28-7-4.83,5-15.24-1.79-20.12-3.14,2.5-7.75-.89-8.12,5.14.54.54,1.61.9,1.19,1.72,3.67,2.64,5-2.82,6-3.13,1,6-9.15,13.27-4,19.08,8.31,3.25,14.46-.79,21-3.43-6.92-5.77-.46-15.48-6.33-21.54M215.54,41.6c3.77-7,13.32-16.26,2.77-21.71-8.12,4.94-15.84-1.23-24,4.4,4.94,8.34-1.75,16.24-1.53,24.41,11.24-2.53,2.5-20,12.79-24.65,1.63,7.2-.83,16.71-4.08,21.66,13.24,2.83,4.05-19,14.7-22.59,4.83,7.23-1.17,14.06-4.71,21,3.8,3.77,15.55,1,10.11-5.58-2,1-4.19,6.2-6.06,3.09m-146.48,54c-7.36,2-18.11,7.83-24.49,4.9,7.89-16.26,6.48-25.07,6.16-41.27,26.33-9.79,28.63,23.41,18.33,36.37M58.14,95.1c9.71-.53,11.54-27.27,4.46-32.16l-3-.56c-1.44,11.56-6.85,25.87-1.42,32.72M87.73,73.47c-3,1.08-3.9,5.07-8.2,4.46,1,11.08,3.19,18.3-.2,27.34,1.89,2,5.21-1.18,6.21-3.81-2.31-5.16-1.38-17.08.46-22.59-.45,2,.34,3,2.37,3.18,2.07-2.89,4.3-7-.64-8.58m13.06-.68c-3.27-4.62-10.36,2.38-4.78,5.84-5.86,2.85-9.58,10.91-1.77,13.67,6.11-3.64,5,0,8.85-.39,5.51-5.74,5.45-14,8-21-2.05.81-3.15-.52-5.56,1.13.07,5.82-2.8,17.23-10.29,14.93.39-5.37,6.62-8.13,5.6-14.14m29.86-1.45c-5.66-3.34-12-.41-17.84-.56,2.92,5.24,2.58,13,.78,21.79l4.63.63c.61-5.67-1.11-19.2,4.77-21,7.55,4.12-.64,14.64-1.87,20.49,5.12.91,9.67,1.09,11.61-2.18-1.93-1.29-1-4.77-2.94-6.06-1.2,1-3.22,6.57-4.33,4.12,1.14-6.51,7-8.39,5.19-17.2m11.58-16.07c-1.12,1.49-2.76-.55-3.72,1.91,2.19,11.91-4.45,25.18.94,36.6,1.38-1.22,3.36,1.55,4.47-1.35-7-11.39,2.18-25.28-1.69-37.16m11.82,33.79c-5.21-3.92-5.65-17.25-14.94-14,5.72,5.67,8.51,13.1,13.08,17.74,4.11.38,7.72.25,6.54-4.67-2.21-2.28-1.74,1.4-4.68.94M148,70.54c2.39-.34,2,2.42,3.81.71,1-3.69-2-3.79-5.33-3.5-3.71,3.48-3.36,8.82-8,13.08,7.57,2.43,5.29-7.34,9.54-10.29m25.95,2c1,3.83-.26,10.18,3.73,14.94-2.6,3.94-7.83,5.24-14,5.6-.42-.83-.82-1.66-1.87-1.87.37-6.47,1.45-12.24,8.4-12.14.67-2.85-.95-3.4-.93-5.6-2.54.87-1.78,5.07-6.54,3.73-1.64-8.66,7.68-8.62,11.22-4.66M167.38,89.4c3.92.45,4.88-6.9,2.79-9.34-1.67,2.17-5.79,5.42-2.79,9.34m15.46-17.27c1.3,7.27-1.36,13.71-2.28,20.52,10.09-.37,4.24-14.56,9-20.45a6,6,0,0,0,3.33,3.41c3.27-2.24,3.72-5.07,1.12-8.56a24.67,24.67,0,0,0-11.17,5.08m16.83-.49c2.84-2.11,5.72-.07,8.58-.75,1.56-5.53-1.94-11,1.81-16.54,7.9,10.57-.79,26.81,1.74,39.62l-2,2c-13.07-.91-16.57-13.15-10.17-24.33m4.85,20.42c5.22-6.21,6.55-15.19-.87-19.15-3.28,6.43-3.38,12.81.87,19.15"></path>
      </svg>
      <div id="loading" class="hidden">Loading...</div>
      <audio controls id="audio-player"></audio>
      <div id="errors"></div>
    </div>

    <script>
      const CLIENT_ID = 'mf63fmaowmhulcp';
      const AUTH_URL = 'https://caplinger.me/pages/radio';
      let files = [];

      function getAccessTokenFromUrl() {
        const params = window.location.hash.substring(1).split('&').reduce((acc, pair) => {
          const [key, value] = pair.split('=');
          return {
            ...acc,
            [key]: value,
          }
        }, {});

        return params.access_token;
      }

      function isAuthenticated() {
        return !!getAccessTokenFromUrl();
      }

      function isAudio(filename) {
        return /\.mp3|\.m4a|\.wav/.test(filename);
      }

      function nextFile() {
        const fileIndex = Math.floor(Math.random() * files.length)
        const file = files[fileIndex];
        files.splice(fileIndex, 1)
        return file;
      }

      async function playFile(file, opts = {}) {
        const dbx = new Dropbox.Dropbox({ accessToken: getAccessTokenFromUrl() });

        const { randomStart = false } = opts;
        const { result } = await dbx.filesDownload({ path: file.path_lower });
        const blob = new Blob([result.fileBlob], { type: 'audio/mp3' });
        const downloadUrl = URL.createObjectURL(blob);

        const audioPlayer = document.getElementById('audio-player');
        audioPlayer.setAttribute('volume', 0)
        audioPlayer.setAttribute('src', downloadUrl);
        audioPlayer.onended = () => {
          const next = nextFile();
          const loading = document.getElementById('loading');
          loading.removeAttribute('class');
          playFile(next);
        };
        audioPlayer.onloadeddata = () => {
          const loading = document.getElementById('loading');
          loading.setAttribute('class', 'hidden');
          if (randomStart) {
            audioPlayer.currentTime = audioPlayer.duration * Math.random();
          } else {;
            audioPlayer.play();
          }
          audioPlayer.volume = 1;
        };
      }

      (async () => {
        let dbx;

        if (isAuthenticated()) {
          dbx = new Dropbox.Dropbox({ accessToken: getAccessTokenFromUrl() });
        } else {
          dbx = new Dropbox.Dropbox({ clientId: CLIENT_ID });
          const authUrl = await dbx.auth.getAuthenticationUrl(AUTH_URL);
          window.location.href = authUrl;
        }

        try {
          const response = await dbx.filesListFolder({ path: '/music/aquarium drunkard', recursive: true })
            files = await response.result.entries.filter(entry => entry['.tag'] === 'file' && isAudio(entry.name));
            const next = nextFile();
            const loading = document.getElementById('loading');
            loading.removeAttribute('class');
            playFile(next, { randomStart: true });
          } catch (err) {
            const errors = document.getElementById('errors');
            errors.innerText = err.message;
            console.error(err);
          }

            const audioPlayer = document.getElementById('audio-player');
            const logo = document.getElementById('ad-logo');
            logo.onclick = () => {
              if (audioPlayer.paused) {
                document.getElementById('ad-logo').setAttribute('class', 'pulse');
                audioPlayer.play();
              } else {
                document.getElementById('ad-logo').removeAttribute('class');
                audioPlayer.pause();
              }
            };

        })()
    </script>
  </body>
</html>
